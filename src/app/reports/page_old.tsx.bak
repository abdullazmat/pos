"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Header from "@/components/layout/Header";
import {
  Calendar,
  Download,
  TrendingUp,
  Package,
  DollarSign,
  ShoppingCart,
  BarChart3,
} from "lucide-react";

export default function ReportsPage() {
  const router = useRouter();
  const [activeTab, setActiveTab] = useState("general");
  const [reportData, setReportData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<any>(null);
  const [fromDate, setFromDate] = useState<string>("");
  const [toDate, setToDate] = useState<string>("");

  // Format a Date to yyyy-mm-dd for <input type="date">
  const fmt = (d: Date) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const tabs = [
    { id: "general", label: "Resumen General", icon: BarChart3 },
    { id: "categories", label: "Por Categorías", icon: Package, premium: true },
    { id: "profitability", label: "Rentabilidad", icon: DollarSign, premium: true },
    { id: "products", label: "Productos", icon: ShoppingCart, premium: true },
  ];

  useEffect(() => {
    const userStr = localStorage.getItem("user");
    if (!userStr) {
      router.push("/auth/login");
      return;
    }
    setUser(JSON.parse(userStr));
    // Set default range to last 7 days (inclusive of today)
    const today = new Date();
    const start = new Date();
    start.setDate(today.getDate() - 6);
    const defaultFrom = fmt(start);
    const defaultTo = fmt(today);
    setFromDate(defaultFrom);
    setToDate(defaultTo);
    // Load default report with last 7 days - delay to ensure state is set
    setTimeout(() => {
      const token = localStorage.getItem("accessToken");
      const params = new URLSearchParams({
        type: "daily",
        from: defaultFrom,
        to: defaultTo,
      });
      fetch(`/api/reports?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` },
      })
        .then((res) => res.json())
        .then((data) => {
          setReportData(data.data);
          setLoading(false);
        })
        .catch((err) => {
          console.error("Load report error:", err);
          setLoading(false);
        });
    }, 0);
  }, [router]);

  const loadReport = async (type: string) => {
    try {
      const token = localStorage.getItem("accessToken");
      const params = new URLSearchParams({ type });
      if (fromDate) params.append("from", fromDate);
      if (toDate) params.append("to", toDate);
      const response = await fetch(`/api/reports?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      setReportData(data.data);
    } catch (error) {
      console.error("Load report error:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleTypeChange = (type: string) => {
    setReportType(type);
    loadReport(type);
  };

  const filteredSales = useMemo(() => {
    if (!reportData?.sales) return [];
    const q = query.trim().toLowerCase();
    return reportData.sales.filter((s: any) => {
      const time = new Date(s.createdAt).toLocaleString().toLowerCase();
      const amount = String(s.total);
      return time.includes(q) || amount.includes(q);
    });
  }, [reportData, query]);

  // Lightweight SVG charts without external dependencies
  function DailyStatsChart({ dailyData }: { dailyData: any[] }) {
    const width = 640;
    const height = 200;
    const pad = 40;
    const gap = 8;
    let items = Array.isArray(dailyData) ? dailyData : [];
    let isSample = false;

    // Generate sample data if no real data
    if (items.length === 0) {
      isSample = true;
      const today = new Date();
      items = Array.from({ length: 7 }, (_, i) => {
        const date = new Date();
        date.setDate(today.getDate() - (6 - i));
        return {
          date: date.toISOString().split("T")[0],
          sales: Math.floor(Math.random() * 15) + 5,
          revenue: Math.floor(Math.random() * 800) + 200,
        };
      });
    }

    const maxRevenue = Math.max(
      1,
      ...items.map((d: any) => Number(d?.revenue ?? 0))
    );
    const barCount = items.length;
    const barWidth = Math.max(
      20,
      (width - pad * 2 - gap * (barCount - 1)) / barCount
    );

    return (
      <div className="space-y-2">
        {isSample && (
          <div className="inline-flex items-center gap-1 px-2 py-1 mb-2 text-xs font-medium text-blue-700 bg-blue-100 rounded">
            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fillRule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clipRule="evenodd"
              />
            </svg>
            Datos de Ejemplo - Aún no hay ventas reales
          </div>
        )}
        <svg
          className="w-full"
          viewBox={`0 0 ${width} ${height}`}
          role="img"
          aria-label="Daily sales trend"
        >
          <rect
            x={0}
            y={0}
            width={width}
            height={height}
            fill="#fafafa"
            rx={8}
          />
          {items.map((d: any, i: number) => {
            const revenue = Number(d?.revenue ?? 0);
            const barH = Math.max(
              4,
              ((height - pad * 2) * revenue) / maxRevenue
            );
            const x = pad + i * (barWidth + gap);
            const y = height - pad - barH;
            const dayLabel = new Date(d.date).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
            return (
              <g key={i}>
                <rect
                  x={x}
                  y={y}
                  width={barWidth}
                  height={barH}
                  rx={3}
                  fill="#3b82f6"
                />
                <text
                  x={x + barWidth / 2}
                  y={height - 8}
                  fontSize="10"
                  fill="#666"
                  textAnchor="middle"
                >
                  {dayLabel}
                </text>
                <text
                  x={x + barWidth / 2}
                  y={y - 4}
                  fontSize="10"
                  fill="#333"
                  textAnchor="middle"
                  fontWeight="600"
                >
                  ${revenue.toFixed(0)}
                </text>
              </g>
            );
          })}
        </svg>
      </div>
    );
  }

  function ProductSalesChart({ products }: { products: any[] }) {
    const width = 640;
    const height = 200;
    const pad = 40;
    const gap = 8;
    let items = Array.isArray(products)
      ? products.filter((p: any) => p.sold > 0).slice(0, 10)
      : [];
    let isSample = false;

    // Generate sample data if no real sales
    if (items.length === 0) {
      isSample = true;
      const sampleProducts = [
        "Coffee",
        "Tea",
        "Sandwich",
        "Muffin",
        "Juice",
        "Salad",
        "Bagel",
      ];
      items = sampleProducts.map((name, i) => ({
        name,
        sold: Math.floor(Math.random() * 30) + 10,
        revenue: Math.floor(Math.random() * 400) + 100,
      }));
    }

    const maxSold = Math.max(1, ...items.map((p: any) => Number(p?.sold ?? 0)));
    const barCount = items.length;
    const barWidth = Math.max(
      20,
      (width - pad * 2 - gap * (barCount - 1)) / barCount
    );

    return (
      <div className="space-y-2">
        {isSample && (
          <div className="inline-flex items-center gap-1 px-2 py-1 mb-2 text-xs font-medium text-green-700 bg-green-100 rounded">
            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fillRule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clipRule="evenodd"
              />
            </svg>
            Datos de Ejemplo - Aún no hay ventas de productos
          </div>
        )}
        <svg
          className="w-full"
          viewBox={`0 0 ${width} ${height}`}
          role="img"
          aria-label="Top selling products"
        >
          <rect
            x={0}
            y={0}
            width={width}
            height={height}
            fill="#fafafa"
            rx={8}
          />
          {items.map((p: any, i: number) => {
            const sold = Number(p?.sold ?? 0);
            const barH = Math.max(4, ((height - pad * 2) * sold) / maxSold);
            const x = pad + i * (barWidth + gap);
            const y = height - pad - barH;
            const shortName = (p.name || "").substring(0, 8);
            return (
              <g key={i}>
                <rect
                  x={x}
                  y={y}
                  width={barWidth}
                  height={barH}
                  rx={3}
                  fill="#10b981"
                />
                <text
                  x={x + barWidth / 2}
                  y={height - 8}
                  fontSize="9"
                  fill="#666"
                  textAnchor="middle"
                >
                  {shortName}
                </text>
                <text
                  x={x + barWidth / 2}
                  y={y - 4}
                  fontSize="10"
                  fill="#333"
                  textAnchor="middle"
                  fontWeight="600"
                >
                  {sold}
                </text>
              </g>
            );
          })}
        </svg>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        Cargando...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header user={user} showBackButton={true} />

      <main className="p-6 mx-auto max-w-7xl">
        {/* Toolbar */}
        <div className="p-4 mb-6 bg-white border border-gray-100 rounded-xl">
          <div className="flex flex-wrap gap-3 md:flex-nowrap md:items-center">
            <button
              onClick={() => handleTypeChange("daily")}
              className={`px-4 py-2 rounded-lg font-semibold transition ${
                reportType === "daily"
                  ? "bg-blue-600 text-white"
                  : "bg-gray-100 text-gray-800 hover:bg-gray-200"
              }`}
            >
              Ventas Diarias
            </button>
            <button
              onClick={() => handleTypeChange("products")}
              className={`px-4 py-2 rounded-lg font-semibold transition ${
                reportType === "products"
                  ? "bg-blue-600 text-white"
                  : "bg-gray-100 text-gray-800 hover:bg-gray-200"
              }`}
            >
              Análisis de Productos
            </button>

            <div className="flex-1" />

            <div className="flex items-center gap-2 mt-2 md:mt-0">
              <div className="relative">
                <Calendar className="absolute w-4 h-4 text-gray-400 -translate-y-1/2 left-3 top-1/2" />
                <input
                  type="date"
                  value={fromDate}
                  onChange={(e) => setFromDate(e.target.value)}
                  className="py-2 pr-3 border border-gray-200 rounded-lg pl-9"
                />
              </div>
              <span className="text-gray-500">a</span>
              <div className="relative">
                <Calendar className="absolute w-4 h-4 text-gray-400 -translate-y-1/2 left-3 top-1/2" />
                <input
                  type="date"
                  value={toDate}
                  onChange={(e) => setToDate(e.target.value)}
                  className="py-2 pr-3 border border-gray-200 rounded-lg pl-9"
                />
              </div>
              <button
                onClick={() => loadReport(reportType)}
                className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg"
              >
                <RefreshCw className="w-5 h-5" />
                Actualizar
              </button>
              <button
                onClick={() => {
                  const blob = new Blob(
                    [JSON.stringify(reportData || {}, null, 2)],
                    { type: "application/json" }
                  );
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `report-${reportType}.json`;
                  a.click();
                  URL.revokeObjectURL(url);
                }}
                className="flex items-center gap-2 px-3 py-2 text-white bg-blue-600 rounded-lg"
              >
                <Download className="w-5 h-5" /> Exportar
              </button>
            </div>
          </div>
          {reportType === "daily" && reportData && (
            <div className="p-5 bg-white border border-gray-100 rounded-xl">
              <div className="flex items-center gap-2 mb-3 text-gray-600">
                <BarChart3 className="w-4 h-4" />
                <span className="text-sm font-medium">
                  Reporte de Ventas Diarias
                </span>
              </div>
              <div className="flex flex-wrap items-center justify-between gap-3 mb-5">
                <p className="text-gray-500">Fecha: {reportData.date}</p>
                <div className="flex items-center gap-2 text-sm text-gray-500">
                  <Calendar className="w-4 h-4" />
                  <span>
                    Rango: {fromDate || "—"} a {toDate || "—"}
                  </span>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-6 mb-6 md:grid-cols-3">
                <div className="p-6 bg-white border border-gray-100 rounded-xl">
                  <p className="text-xs text-gray-500">Ventas Totales</p>
                  <p className="text-3xl font-bold">
                    {reportData.totalSales || 0}
                  </p>
                  {reportData.totalSales === 0 && (
                    <p className="mt-1 text-xs text-gray-400">
                      Aún no hay ventas registradas
                    </p>
                  )}
                </div>
                <div className="p-6 bg-white border border-gray-100 rounded-xl">
                  <p className="text-xs text-gray-500">Ingresos Totales</p>
                  <p className="text-3xl font-bold">
                    ${Number(reportData?.totalRevenue ?? 0).toFixed(2)}
                  </p>
                  {!reportData.totalRevenue && (
                    <p className="mt-1 text-xs text-gray-400">
                      Empezá a vender para registrar ingresos
                    </p>
                  )}
                </div>
                <div className="p-6 bg-white border border-gray-100 rounded-xl">
                  <p className="text-xs text-gray-500">Promedio por Venta</p>
                  <p className="text-3xl font-bold">
                    $
                    {(
                      Number(reportData?.totalRevenue ?? 0) /
                      (Number(reportData?.totalSales ?? 0) || 1)
                    ).toFixed(2)}
                  </p>
                  {reportData.totalSales === 0 && (
                    <p className="mt-1 text-xs text-gray-400">
                      Promedio por transacción
                    </p>
                  )}
                </div>
              </div>

              <div className="p-4 mb-4 bg-white border border-gray-100 rounded-xl">
                <div className="flex items-center gap-2 mb-3 text-gray-600">
                  <BarChart3 className="w-5 h-5" />
                  <span className="font-semibold">
                    Tendencia de Ventas (7 Días)
                  </span>
                </div>
                <DailyStatsChart dailyData={reportData.dailyData || []} />
              </div>

              <div className="p-4 mt-4 border border-gray-100 bg-gray-50 rounded-xl">
                <div className="flex items-center justify-between mb-3">
                  <div className="relative w-64">
                    <Search className="absolute w-4 h-4 text-gray-400 -translate-y-1/2 left-3 top-1/2" />
                    <input
                      value={query}
                      onChange={(e) => setQuery(e.target.value)}
                      placeholder="Buscar ventas por hora o monto"
                      className="w-full py-2 pr-3 border border-gray-200 rounded-lg pl-9"
                    />
                  </div>
                  <div className="flex items-center gap-2 text-sm text-gray-500">
                    <PieChart className="w-4 h-4" />
                    <span>
                      Total artículos:{" "}
                      {reportData.sales?.reduce(
                        (acc: number, s: any) => acc + (s.items?.length || 0),
                        0
                      )}
                    </span>
                  </div>
                </div>

                {filteredSales?.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-gray-50">
                          <th className="px-3 py-2 text-left">Hora</th>
                          <th className="px-3 py-2 text-right">Monto</th>
                          <th className="px-3 py-2 text-right">Artículos</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredSales.map((sale: any, idx: number) => (
                          <tr key={idx} className="border-b hover:bg-gray-50">
                            <td className="px-3 py-2">
                              {new Date(sale.createdAt).toLocaleTimeString()}
                            </td>
                            <td className="px-3 py-2 text-right">
                              ${sale.total.toFixed(2)}
                            </td>
                            <td className="px-3 py-2 text-right">
                              {sale.items.length}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <p className="text-gray-500">No se encontraron ventas</p>
                )}
              </div>
            </div>
          )}

          {reportType === "products" && reportData && (
            <div className="p-5 bg-white border border-gray-100 rounded-xl">
              <div className="flex items-center justify-between gap-2 mb-5">
                <div className="flex items-center gap-2 text-gray-600">
                  <PieChart className="w-5 h-5" />
                  <span className="font-semibold">Análisis de Productos</span>
                </div>
                {reportData.dateRange && (
                  <div className="flex items-center gap-2 text-sm text-gray-500">
                    <Calendar className="w-4 h-4" />
                    <span>
                      Rango: {reportData.dateRange.from} a{" "}
                      {reportData.dateRange.to}
                    </span>
                  </div>
                )}
              </div>

              <div className="p-4 mb-6 bg-white border border-gray-100 rounded-xl">
                <div className="flex items-center gap-2 mb-3 text-gray-600">
                  <BarChart3 className="w-5 h-5" />
                  <span className="font-semibold">
                    Productos Más Vendidos (Últimos 7 Días)
                  </span>
                </div>
                <ProductSalesChart products={reportData.products || []} />
              </div>
              <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                {reportData.products && reportData.products.length > 0 ? (
                  reportData.products.map((product: any, idx: number) => (
                    <div
                      key={idx}
                      className="p-6 bg-white border border-gray-100 rounded-xl"
                    >
                      <div className="flex items-start justify-between mb-3">
                        <h3 className="text-lg font-semibold">
                          {product.name}
                        </h3>
                        <span className="px-2 py-1 text-xs text-gray-600 bg-gray-100 rounded">
                          {product.category || "—"}
                        </span>
                      </div>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div className="p-2 rounded bg-blue-50">
                          <p className="text-xs text-gray-600">Stock Actual</p>
                          <p className="font-bold">{product.stock}</p>
                        </div>
                        <div className="p-2 rounded bg-green-50">
                          <p className="text-xs text-gray-600">
                            Unidades Vendidas
                          </p>
                          <p className="font-bold">{product.sold || 0}</p>
                        </div>
                        <div className="p-2 rounded bg-purple-50">
                          <p className="text-xs text-gray-600">
                            Ingresos por Ventas
                          </p>
                          <p className="font-bold">
                            ${(product.revenue || 0).toFixed(2)}
                          </p>
                        </div>
                        <div className="p-2 rounded bg-orange-50">
                          <p className="text-xs text-gray-600">Precio</p>
                          <p className="font-bold">
                            ${product.price.toFixed(2)}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <>
                    {[
                      {
                        name: "Espresso",
                        category: "Beverages",
                        stock: 45,
                        sold: 23,
                        revenue: 92,
                        price: 4,
                      },
                      {
                        name: "Croissant",
                        category: "Bakery",
                        stock: 30,
                        sold: 18,
                        revenue: 72,
                        price: 4,
                      },
                      {
                        name: "Cappuccino",
                        category: "Beverages",
                        stock: 50,
                        sold: 31,
                        revenue: 155,
                        price: 5,
                      },
                      {
                        name: "Sandwich",
                        category: "Food",
                        stock: 25,
                        sold: 15,
                        revenue: 120,
                        price: 8,
                      },
                      {
                        name: "Muffin",
                        category: "Bakery",
                        stock: 40,
                        sold: 12,
                        revenue: 48,
                        price: 4,
                      },
                      {
                        name: "Orange Juice",
                        category: "Beverages",
                        stock: 35,
                        sold: 9,
                        revenue: 45,
                        price: 5,
                      },
                    ].map((product, idx) => (
                      <div
                        key={idx}
                        className="relative p-6 bg-white border border-gray-100 rounded-xl"
                      >
                        {idx === 0 && (
                          <div className="absolute top-2 right-2">
                            <span className="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-purple-700 bg-purple-100 rounded">
                              <svg
                                className="w-3 h-3"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                              >
                                <path
                                  fillRule="evenodd"
                                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                  clipRule="evenodd"
                                />
                              </svg>
                              Ejemplo
                            </span>
                          </div>
                        )}
                        <div className="flex items-start justify-between mb-3">
                          <h3 className="text-lg font-semibold">
                            {product.name}
                          </h3>
                          <span className="px-2 py-1 text-xs text-gray-600 bg-gray-100 rounded">
                            {product.category}
                          </span>
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div className="p-2 rounded bg-blue-50">
                            <p className="text-xs text-gray-600">
                              Stock Actual
                            </p>
                            <p className="font-bold">{product.stock}</p>
                          </div>
                          <div className="p-2 rounded bg-green-50">
                            <p className="text-xs text-gray-600">
                              Unidades Vendidas
                            </p>
                            <p className="font-bold">{product.sold}</p>
                          </div>
                          <div className="p-2 rounded bg-purple-50">
                            <p className="text-xs text-gray-600">
                              Ingresos por Ventas
                            </p>
                            <p className="font-bold">
                              ${product.revenue.toFixed(2)}
                            </p>
                          </div>
                          <div className="p-2 rounded bg-orange-50">
                            <p className="text-xs text-gray-600">Precio</p>
                            <p className="font-bold">
                              ${product.price.toFixed(2)}
                            </p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      </main>
    </div>
  );
}
